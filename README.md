# v2ray-stat API

API для управления пользователями и статистикой сервера **v2ray-stat**.

Все запросы по умолчанию отправляются на `http://127.0.0.1:9952`.

---

# Содержание

1. Обзор
2. Эндпоинты
   * Получение статистики по серверу и клиентам — `GET /api/v1/stats`
   * Получение DNS-статистики — `GET /api/v1/dns_stats`
   * Добавление пользователя на ноды — `POST /api/v1/add_user`
3. Примеры конфигурации и включение API в ядрах (Singbox, Xray)
4. Генерация сертификатов

---

# 1. Обзор

Этот документ описывает API для сбора статистики и управления пользователями в проекте **v2ray-stat**. API позволяет:

* получать статистику по серверам, клиентам и DNS-запросам с поддержкой фильтрации и сортировки;
* добавлять пользователей на указанные ноды;
* настраивать интеграцию и включать API в ядрах (Singbox / Xray).

---

# 2. Эндпоинты

## Получение статистики по серверу и клиентам

**GET** `/api/v1/stats`

Возвращает статистику по серверу и клиентам. Поддерживает фильтрацию по нодам и пользователям, сортировку и агрегацию. Работа основана на конфигурации `stats_columns` и данных из таблиц `bound_traffic`, `user_traffic`, `user_data` и `user_uuids`.

### Пример запроса

```bash
curl -X GET "http://127.0.0.1:9952/api/v1/stats?node=node1,node2&user=user1&sort_by=rate&sort_order=desc&aggregate=true"
```

### Параметры запроса

| Параметр     | Описание                                                  |
| ------------ | --------------------------------------------------------- |
| `node`       | Имя узла (или список через запятую) — фильтрация по нодам |
| `user`       | Имя пользователя (или список через запятую)               |
| `sort_by`    | Колонка для сортировки (см. поддерживаемые колонки)       |
| `sort_order` | `asc` или `desc`                                          |
| `aggregate`  | `true` — агрегировать данные по пользователям/источникам  |

### Поддерживаемые колонки для сортировки

**Server:**

* `node_name` — имя ноды
* `source` — источник трафика (IP или hostname)
* `rate` — текущий трафик (бит/с)
* `uplink` — всего отправлено (байт)
* `downlink` — всего получено (байт)
* `sess_uplink` — отправлено в текущей сессии (байт)
* `sess_downlink` — получено в текущей сессии (байт)

**Client:**

* `node_name` — имя ноды
* `user` — имя пользователя
* `last_seen` — время последней активности
* `rate` — текущий трафик (бит/с)
* `uplink` — всего отправлено (байт)
* `downlink` — всего получено (байт)
* `sess_uplink` — отправлено в текущей сессии (байт)
* `sess_downlink` — получено в текущей сессии (байт)
* `created` — дата создания пользователя
* `inbound_tag` — тег входящего соединения (например, `vless-in`)
* `uuid` — уникальный идентификатор пользователя
* `sub_end` — дата окончания подписки
* `renew` — статус/период автопродления
* `lim_ip` — ограничение по количеству IP
* `ips` — список IP-адресов
* `enabled` — статус активности пользователя

### Конфигурация примера (YAML)

```yaml
stats_columns:
  server:
    sort_by: rate
    sort_order: desc
    columns:
      - source
      - rate
      - uplink
      - downlink
  client:
    sort_by: user
    sort_order: asc
    columns:
      - user
      - last_seen
      - rate
      - uplink
      - downlink
      - inbound_tag
      - uuid
```

### Пример без статистики по серверу

```yaml
stats_columns:
  server:
    columns: []
  client:
    columns:
      - user
      - rate
      - uplink
      - downlink
      - inbound_tag
      - uuid
```

### Переопределение сортировки через URL

```bash
curl "http://127.0.0.1:9952/api/v1/stats?sort_by=uuid&sort_order=asc"
```

### Пример ответа

```
➤  Server Statistics:
Node    Source         Rate    Uplink    Downlink
node1   192.168.1.1    500     1000      2000
node2   10.0.0.1       300     500       1500

➤  Client Statistics:
Node    User    Last seen         Rate    Uplink    Downlink    Inbound Tag    UUID
node1   user1   2025-08-08 12:00  200     300       400         vless-in       550e8400-e29b-41d4-a716-446655440000
node2   user2   2025-08-08 11:30  100     200       300         trojan-in      6ba7b810-9dad-11d1-80b4-00c04fd430c8
```

### Примечания

* Если `columns` в конфигурации пустой — соответствующая часть статистики не отображается.
* При агрегации (`aggregate=true`) данные группируются по пользователям (`user`) или источникам (`source`), а `node_name` исключается из результата.
* Если статистика отсутствует, возвращается сообщение: `No statistics available.`.
* Ответ форматируется как текстовая таблица с псевдонимами колонок (например, `Rate`, `Uplink`, `Inbound Tag`).

---

## Получение DNS-статистики

**GET** `/api/v1/dns_stats`

Возвращает статистику DNS-запросов из таблицы `user_dns`. Поддерживает фильтрацию по нодам, пользователям и доменам, а также ограничение количества записей.

### Пример запроса

```bash
curl -X GET "http://127.0.0.1:9952/api/v1/dns_stats?node=node1,node2&user=user1&domain=example.com&count=20"
```

### Параметры запроса

| Параметр | Описание                                                                 |
| -------- | ------------------------------------------------------------------------ |
| `node`   | Имя узла (или список через запятую) — фильтрация по нодам (опционально)  |
| `user`   | Имя пользователя (или список через запятую) — фильтрация по пользователям (опционально) |
| `domain` | Часть доменного имени для поиска (поддерживает подстроку, опционально)   |
| `count`  | Количество возвращаемых записей (по умолчанию 20, максимум 1000)         |

### Пример ответа

```
➤  DNS Query Statistics:
Node    User    Count    Domain
node1   user1   150      example.com
node2   user1   100      sub.example.com
node1   user2   50       test.com
```

### Примечания

* Если параметры `node`, `user` или `domain` не указаны, возвращаются все соответствующие записи.
* Параметр `count` должен быть положительным числом (1–1000). Если не указан, используется значение по умолчанию (20).
* Параметр `domain` поддерживает частичное совпадение (например, `example` найдет `example.com` и `sub.example.com`).
* Если длина `domain` превышает 255 символов, возвращается ошибка.
* Если указаны несуществующие ноды, возвращается ошибка.
* Если статистика отсутствует, возвращается сообщение: `No DNS statistics available.`.
* Ответ форматируется как текстовая таблица с колонками: `Node`, `User`, `Count`, `Domain`.

---

## Добавление пользователя с указанием нод

**POST** `/api/v1/add_user`

Добавляет пользователя на указанные ноды. Если `nodes` не указан или пустой — пользователь добавляется на все доступные ноды.

### Тело запроса (JSON)

* `user` — имя пользователя (строка, только буквы, цифры, дефис или подчеркивание)
* `inbound_tag` — тег входящего соединения (строка), например `vless-in` или `trojan-in`
* `nodes` — массив строк, список нод (опционально)

### Пример запроса

```bash
curl -X POST http://127.0.0.1:9952/api/v1/add_user -H "Content-Type: application/json" -d '{
    "user": "testuser",
    "inbound_tag": "vless-in",
    "nodes": ["node1", "node2"]
}'
```

### Пример ответа

```json
{
  "node1": "550e8400-e29b-41d4-a716-446655440000",
  "node2": "6ba7b810-9dad-11d1-80b4-00c04fd430c8"
}
```

### Примечания

* Поля `user` и `inbound_tag` обязательны. При их отсутствии возвращается ошибка 400 (`user and inbound_tag are required`).
* Если указаны несуществующие ноды, возвращается ошибка 400 (`no valid nodes found for the provided names`).
* Ответ содержит JSON-объект, где ключи — имена нод, а значения — сгенерированные учетные данные (`credential`, например, UUID).
* Ошибки сервера возвращают статус 500 с описанием проблемы.

---

# 3. Включение API в ядрах

Ниже — примеры конфигурации для включения API и статистики в ядрах **Singbox** и **Xray**.

## Singbox (пример)

```json
"experimental": {
  "v2ray_api": {
    "listen": "127.0.0.1:9953",
    "stats": {
      "enabled": true,
      "inbounds": [
        "trojan-in",
        "vless-in"
      ],
      "outbounds": [
        "warp",
        "direct",
        "IPv4"
      ],
      "users": [
        "user1",
        "user2"
      ]
    }
  }
}
```

## Xray (пример)

```json
"api": {
  "tag": "api",
  "listen": "127.0.0.1:9953",
  "services": [
    "HandlerService",
    "StatsService",
    "ReflectionService"
  ]
}
```

---

# 4. Генерация сертификатов

Примеры команд для проверки/просмотра сертификатов:

```bash
openssl x509 -in /usr/local/etc/v2ray-stat/certs/node.crt -text -noout
openssl rsa -in /usr/local/etc/v2ray-stat/certs/node.key -check
```

### Рекомендации

* Используйте уникальные пары ключ/сертификат для каждой ноды или централизованно подпишите сертификаты CA.
* Храните приватные ключи в защищённом каталоге с ограниченным доступом.
# v2ray-stat Configuration File
# This file specifies paths and settings for the v2ray-stat monitoring application.

# Log Settings
log:
  loglevel: info                                          # Logging level: none, error, warn, info, debug, trace. NONE disables logging; each level includes messages from lower levels.
  logmode: inclusive                                      # Log mode: inclusive = this and lower levels; exclusive = only this level

# API Settings
api:
  api_token: ""                                           # Token required to access the API endpoints. If empty, access is allowed without authorization. Format: Bearer <token>.
 
# Timezone Settings 
timezone: Asia/Bangkok                                    # IANA timezone name (e.g., Europe/Amsterdam, Asia/Singapore). If empty, uses TZ environment variable or UTC.

# v2ray-stat Settings
v2rs-backend:
  address: 127.0.0.1                                      # IP address of the v2ray-stat API server. 127.0.0.1 means it is accessible only locally (localhost).
  port: 9243                                              # TCP port for v2ray-stat API server. Must be between 1 and 65535.
  monitor:        
    ticker_interval: 10                                   # Interval (in seconds) for polling monitored services and users. Recommended: 5–60.
    online_rate_threshold: 0                              # Minimum rate threshold in kilobits per second (kbps) to consider a user online. 0 means any non-zero rate is considered online.
  nodes:                                                  # List of monitored nodes and their API connection parameters.
    - node_name: swe                                      # Display name of the node.
      address: 127.0.0.1                                  # Node API endpoint address in host format.
      port: 9253                                          # Node API endpoint address in port format.
    - node_name: rus
      address: 1.2.3.4                                    # Node API endpoint address in host format.
      port: 9253                                          # Node API endpoint address in port format.
      mtls:
        cert: /usr/local/etc/v2ray-stat/certs/node.crt
        key: /usr/local/etc/v2ray-stat/certs/node.key
        ca_cert: /usr/local/etc/v2ray-stat/certs/node.crt
    - node_name: nl
      address: example.com                                # Node API endpoint address in host format.
      port: 443                                           # Node API endpoint address in port format.
      mtls:                                               # mTLS (mutual TLS) configuration for secure connection to the node.
        cert: /usr/local/etc/v2ray-stat/certs/node.crt    # Path to the client's TLS certificate.
        key: /usr/local/etc/v2ray-stat/certs/node.key     # Path to the client's private key.
        ca_cert: /usr/local/etc/v2ray-stat/certs/node.crt # Path to the CA certificate for server verification.
  subscription:
    address: 127.0.0.1
    grpc_port: 9263
    # mtls:                                               # mTLS (mutual TLS) configuration for secure connection to the node.
    #   cert: /usr/local/etc/v2ray-stat/certs/node.crt    # Path to the client's TLS certificate.
    #   key: /usr/local/etc/v2ray-stat/certs/node.key     # Path to the client's private key.
    #   ca_cert: /usr/local/etc/v2ray-stat/certs/node.crt # Path to the CA certificate for server verification.

# Paths & Logging 
paths: 
  database: /usr/local/etc/v2ray-stat/data.db             # Path to the SQLite database for tracking user sessions and usage.
  f2b_log: /var/log/v2ray-stat.log                        # Path to the log file for recording v2ray-stat violations or issues (e.g., IP limit exceeded).
  f2b_banned_log: /var/log/v2ray-stat-banned.log          # Path to the log file for recording IP bans and unbans.
  auth_lua: /etc/haproxy/.auth.lua                        # Path to HAProxy's .auth.lua file, dynamically updated if auth_lua feature is enabled.
 
# Statistics Columns Configuration 
stats_columns: 
  server: 
    sort: rate desc                                       # Sorting rule for server statistics. Format: "<column> <ASC|DESC>". Default: "source ASC". Valid columns: source, rate, uplink, downlink, sess_uplink, sess_downlink.
    columns:                                              # List of columns to display in server statistics. If empty, no server statistics are shown.
      - node_name                                         # Node name where the traffic is measured.
      - source                                            # Source of traffic (e.g., IP or hostname).
      - rate                                              # Current traffic rate in bits per second (bps).
      - uplink                                            # Total uploaded traffic in bytes.
      - downlink                                          # Total downloaded traffic in bytes.
      # - sess_uplink                                     # Session-based uploaded traffic in bytes (reset after reconnect).
      # - sess_downlink                                   # Session-based downloaded traffic in bytes (reset after reconnect).
  client: 
    sort: rate desc                                       # Sorting rule for client statistics. Same format and rules as for server stats.
    columns:                                              # List of columns to display in client statistics. If empty, no client statistics are shown.
      - node_name                                         # Node name where the client is connected.
      - user                                              # Client username or identifier.
      - last_seen                                         # Timestamp of the last client activity.
      - rate                                              # Current traffic rate in bits per second (bps).
      - uplink                                            # Total uploaded traffic in bytes.
      - downlink                                          # Total downloaded traffic in bytes.
      - traffic_cap
      # - sess_uplink                                     # Session-based uploaded traffic in bytes (reset after reconnect).
      # - sess_downlink                                   # Session-based downloaded traffic in bytes (reset after reconnect).
      # - enabled                                         # Whether the client is enabled (true/false).
      # - created                                         # Timestamp when the client was created.
      # - sub_end                                         # Subscription end date for the client.
      # - renew                                           # Renewal status or date for the client.
      # - id                                              # Unique client identifier (ID).
      # - inbound_tag                                     # Inbound tag associated with the client.
      # - lim_ip                                          # IP limit for the client (number of allowed IPs).
      # - ips                                             # List of IPs currently used by the client.

###

# V2RS-Node Settings
v2rs-node:
  type: xray                                              # Type of proxy core used for statistics. Accepted values: xray, singbox.
  address: 127.0.0.1                                      # IP address of the proxy core API server. '127.0.0.1' restricts access to localhost.
  port: 9253                                              # TCP port for the proxy core API server. Must be between 1 and 65535.

# Features & Monitoring Options
features:
  auth_lua: true                                          # Enables dynamic updates to HAProxy's auth.lua file for credential management.
  restart: true                                           # Enables automatic restart of services when configuration changes are detected.

# Core Settings
core:
  dir: /usr/local/etc/xray/                               # Directory path where the proxy (Xray or Singbox) config files are stored. Must end with a slash (/).
  config: /usr/local/etc/xray/config.json                 # Path to the main configuration file for the proxy core (e.g., Xray or Singbox config).
  access_log: /usr/local/etc/xray/access.log              # Path to the proxy core's access log file for tracking user sessions and IPs.
  access_log_regex: 'from (?:tcp|udp):([\d\.]+):\d+ accepted (?:tcp|udp):([\w\.\-]+):\d+ \[[^\]]+\] email: (\S+)' # Regular expression to parse access log. Should extract source IP, destination host, and user email/remark.
  # access_log: /var/log/haproxy.log
  # access_log_regex: 'login: (\S+); ip: ([0-9\.]+)'      # Alternative regex (e.g., for custom login formats):

###

# V2RS-Sub Settings
v2rs-sub:
  address: 127.0.0.1                                      # Listening address for the subscription server. '127.0.0.1' restricts access to localhost.
  port: 9264                                              # Listening port for the subscription server. Must be between 1 and 65535.
  grpc_port: 9263                                         # Listening port for the gRPC server.

# Subscription Settings
subscription:
  domains:                                                # Mapping of nodes to domains.
    rus: "example.com"                                    # Node located in Russia
    de: "de.example.com"                                  # Node located in Germany
    us: "us.example.com"                                  # Node located in the United States
  defaults:                                               # Default settings applied to all users unless overridden.
    headers:                                              # HTTP headers included in subscription responses.
      Profile-Title: "base64:U3Vic2NyaXB0aW9u"            # Subscription title (base64-encoded string).
      Profile-Update-Interval: "12"                       # Subscription update interval (hours).
      Support-Url: "https://natribu.org/"                 # Support URL.
      Profile-Web-Page-Url: "https://natribu.org/"        # Profile web page URL.
      Announce: "COME here (ง ͠° ͟ل͜ ͡°)ง"                   # Custom announcement message.
    clients: ["xray", "singbox"]                          # Default list of supported clients (e.g., xray, singbox, mihomo).
    nodes: ["rus"]                                        # Default list of nodes available to users.
    templates:                                            # Default node-to-template mappings.
      base:
        rus: node_rus.base                                # Template for the "rus" node in base mode.
      advanced:
        rus: node_rus.json                                # Template for the "rus" node in advanced mode.
  groups:                                                 # Configuration for user groups with shared settings.
    free:                                                 # Group for free/standard-tier users.
      clients: ["xray"]                                   # Supported clients for this group.
      nodes: ["rus"]                                      # Nodes available to this group.
      templates:                                          # Node-to-template mappings for this group.
        base:
          rus: node_rus.base64                            # Custom template for "rus" in base mode.
        advanced: {}                                      # Clears advanced templates (requests to advanced will return 404).
    premium:                                              # Group for premium-tier users.
      clients: ["xray", "singbox", "mihomo"]              # Supported clients for this group.
      nodes: ["rus", "de", "us"]                          # Nodes available to this group.
      templates:                                          # Node-to-template mappings for this group.
        base:
          rus: node_rus.base64                            # Custom template for "rus" in base mode.
          de: node_de                                     # Template for "de" in base mode.
          us: node_us.base64                              # Template for "us" in base mode.
        advanced:
          rus: node_rus                                   # Advanced template for "rus".
          de: node_de.json                                # Advanced template for "de".
          us: node_us.json                                # Advanced template for "us".
  users:                                                  # User-specific settings (override group or default settings).
    premium:                                              # Group of users inheriting from groups.premium.
      users: ["adam", "zoi"]                              # List of users in the premium group.
    free:                                                 # Group of users inheriting from groups.free.
      users: ["test"]                                     # User "test" inherits settings from the free group.
      headers:                                            # Custom headers overriding group/default headers.
        Announce: "Free"                                  # Custom announcement for this user/group.
